#!/usr/bin/env python3
"""
Boeing 737-800 ç®€åŒ–é£è¡ŒåŒ…çº¿
80%å…¨é‡é…ç½®ï¼ŒåŒè½´æ˜¾ç¤º
"""

import numpy as np
import matplotlib.pyplot as plt
from pyBADA.bada4 import BADA4, Airplane

plt.rcParams['font.sans-serif'] = ['DejaVu Sans', 'Arial Unicode MS', 'SimHei']
plt.rcParams['axes.unicode_minus'] = False

def create_simple_flight_envelope():
    """åˆ›å»ºç®€åŒ–çš„B738é£è¡ŒåŒ…çº¿"""
    
    print("ğŸ›©ï¸ Boeing 737-800 é£è¡ŒåŒ…çº¿")
    print("ğŸ“Š é…ç½®ï¼š80%å…¨é‡ (63,213 kg)")
    print("=" * 40)
    
    # é£æœºå‚æ•°
    aircraft = {
        'mtow': 79016,         # kg
        'operating_weight': 79016 * 0.8,  # 80%å…¨é‡
        'wing_area': 124.58,   # mÂ²
        'max_mach': 0.82,
        'service_ceiling': 41000,  # ft
    }
    
    # é«˜åº¦èŒƒå›´
    altitudes_ft = np.linspace(0, 41000, 100)
    
    # åˆ›å»ºå›¾å½¢
    fig, ax = plt.subplots(figsize=(14, 9))
    
    # è®¡ç®—é£è¡ŒåŒ…çº¿
    stall_speeds, max_speeds, valid_altitudes = calculate_flight_envelope(
        altitudes_ft, aircraft)
    
    # ç»˜åˆ¶åŒ…çº¿
    ax.fill_betweenx(valid_altitudes, stall_speeds, max_speeds,
                    color='lightblue', alpha=0.3, label='Operating Envelope')
    
    ax.plot(stall_speeds, valid_altitudes, 'r-', linewidth=3,
           label='Stall Speed')
    
    ax.plot(max_speeds, valid_altitudes, 'b-', linewidth=3,
           label='Maximum Speed')
    
    # ç»˜åˆ¶é©¬èµ«æ•°ç­‰å€¼çº¿
    draw_mach_lines(ax, altitudes_ft)
    
    # è®¾ç½®åŒè½´
    setup_dual_axis(ax)
    
    # æ·»åŠ å‚è€ƒçº¿
    add_reference_lines(ax)
    
    # ç¾åŒ–
    ax.set_xlabel('Indicated Airspeed (knots)', fontsize=14, fontweight='bold')
    ax.set_ylabel('Altitude (feet)', fontsize=14, fontweight='bold')
    ax.set_title('Boeing 737-800 Flight Envelope\nOperating Weight: 63,213 kg (80% MTOW)', 
                fontsize=16, fontweight='bold', pad=20)
    
    ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)
    ax.set_axisbelow(True)
    ax.set_xlim(50, 500)
    ax.set_ylim(0, 43000)
    
    # å›¾ä¾‹
    ax.legend(loc='upper right', fontsize=12, framealpha=0.9)
    
    # æ€§èƒ½ä¿¡æ¯
    add_performance_info(ax, aircraft, stall_speeds, max_speeds, valid_altitudes)
    
    # ä¿å­˜å’Œæ˜¾ç¤º
    plt.tight_layout()
    plt.savefig('B738_Simple_Envelope.png', dpi=300, bbox_inches='tight')
    
    print(f"\nâœ… é£è¡ŒåŒ…çº¿å·²ä¿å­˜: B738_Simple_Envelope.png")
    plt.show()
    
    # è¾“å‡ºå…³é”®æ•°æ®
    print_key_performance(aircraft, stall_speeds, max_speeds, valid_altitudes)
    
    return fig, ax

def calculate_flight_envelope(altitudes_ft, aircraft):
    """è®¡ç®—é£è¡ŒåŒ…çº¿"""
    
    stall_speeds = []
    max_speeds = []
    valid_altitudes = []
    
    print("ğŸ”§ è®¡ç®—é£è¡ŒåŒ…çº¿æ•°æ®...")
    
    for alt_ft in altitudes_ft:
        alt_m = alt_ft * 0.3048
        
        # ISAæ ‡å‡†å¤§æ°”
        if alt_m <= 11000:  # å¯¹æµå±‚
            temp = 288.15 * (1 - 0.0065 * alt_m / 288.15)
            density_ratio = (temp / 288.15) ** 4.256
        else:  # å¹³æµå±‚
            temp = 216.65
            temp_11km = 288.15 * (1 - 0.0065 * 11000 / 288.15)
            density_ratio_11km = (temp_11km / 288.15) ** 4.256
            density_ratio = density_ratio_11km * np.exp(-(alt_m - 11000) / 6341.62)
        
        # å¤±é€Ÿé€Ÿåº¦è®¡ç®—
        mass = aircraft['operating_weight']
        cl_max = 1.6  # æ¸…æ´æ„å‹æœ€å¤§å‡åŠ›ç³»æ•°
        
        v_stall_ms = np.sqrt(2 * mass * 9.81 / 
                           (1.225 * density_ratio * aircraft['wing_area'] * cl_max))
        v_stall_kt = v_stall_ms * 1.94384
        
        # æœ€å¤§é€Ÿåº¦è®¡ç®—
        # å£°é€Ÿ
        a = np.sqrt(1.4 * 287.053 * temp)
        
        # é©¬èµ«æ•°é™åˆ¶
        v_mach_ms = aircraft['max_mach'] * a
        v_mach_kt = v_mach_ms * 1.94384
        
        # ç»“æ„é™åˆ¶
        if alt_ft < 28000:
            v_max_kt = 340  # VMO
        else:
            # é«˜ç©ºä»¥é©¬èµ«æ•°é™åˆ¶ä¸ºå‡†ï¼Œè½¬æ¢ä¸ºç­‰æ•ˆæŒ‡ç¤ºç©ºé€Ÿ
            v_max_kt = v_mach_ms * np.sqrt(density_ratio) * 1.94384
        
        # æ•°æ®éªŒè¯
        if (v_stall_kt > 80 and v_stall_kt < 200 and
            v_max_kt > v_stall_kt + 50 and v_max_kt < 450 and
            alt_ft <= aircraft['service_ceiling']):
            
            stall_speeds.append(v_stall_kt)
            max_speeds.append(v_max_kt)
            valid_altitudes.append(alt_ft)
    
    print(f"âœ… è®¡ç®—å®Œæˆ: {len(valid_altitudes)} ä¸ªæ•°æ®ç‚¹")
    
    return np.array(stall_speeds), np.array(max_speeds), np.array(valid_altitudes)

def draw_mach_lines(ax, altitudes_ft):
    """ç»˜åˆ¶çœŸæ­£çš„é€Ÿåº¦é™åˆ¶çº¿ï¼šVMO + MMO + æœ€å°é©¬èµ«æ•°"""
    
    print("ğŸ”§ æ·»åŠ é€Ÿåº¦é™åˆ¶çº¿...")
    
    # MMOé™åˆ¶ï¼šMach 0.82ï¼ˆæœ€å¤§é©¬èµ«æ•°ï¼‰
    mmo_speeds = []
    mmo_altitudes = []
    
    # æœ€å°é©¬èµ«æ•°é™åˆ¶ï¼ˆé«˜ç©ºä½é€Ÿé™åˆ¶ï¼‰
    min_mach_speeds = []
    min_mach_altitudes = []
    
    # VMO/MMOè½¬æ¢é«˜åº¦
    transition_altitude = 28000  # ft
    
    for alt_ft in altitudes_ft:
        alt_m = alt_ft * 0.3048
        
        # è®¡ç®—æ¸©åº¦å’Œå¯†åº¦
        if alt_m <= 11000:
            temp = 288.15 * (1 - 0.0065 * alt_m / 288.15)
            density_ratio = (temp / 288.15) ** 4.256
        else:
            temp = 216.65
            temp_11km = 288.15 * (1 - 0.0065 * 11000 / 288.15)
            density_ratio = (temp_11km / 288.15) ** 4.256 * np.exp(-(alt_m - 11000) / 6341.62)
        
        # å£°é€Ÿ
        a = np.sqrt(1.4 * 287.053 * temp)
        
        # MMO: Mach 0.82çš„æŒ‡ç¤ºç©ºé€Ÿ
        v_mmo_true = 0.82 * a
        v_mmo_indicated = v_mmo_true * np.sqrt(density_ratio) * 1.94384
        
        if 100 < v_mmo_indicated < 500 and alt_ft <= 41000:
            mmo_speeds.append(v_mmo_indicated)
            mmo_altitudes.append(alt_ft)
        
        # æœ€å°é©¬èµ«æ•°é™åˆ¶ï¼ˆä¸»è¦åœ¨é«˜ç©ºï¼‰
        if alt_ft > 20000:  # 20,000 ftä»¥ä¸Šæ‰æœ‰æœ€å°é©¬èµ«æ•°é™åˆ¶
            # æœ€å°é©¬èµ«æ•°éšé«˜åº¦å¢åŠ ï¼šä»Mach 0.3åˆ°Mach 0.5
            min_mach = 0.3 + (alt_ft - 20000) / (41000 - 20000) * 0.2
            min_mach = min(min_mach, 0.5)  # ä¸è¶…è¿‡Mach 0.5
            
            v_min_mach_true = min_mach * a
            v_min_mach_indicated = v_min_mach_true * np.sqrt(density_ratio) * 1.94384
            
            if 80 < v_min_mach_indicated < 400:
                min_mach_speeds.append(v_min_mach_indicated)
                min_mach_altitudes.append(alt_ft)
    
    # ç»˜åˆ¶MMOé™åˆ¶çº¿
    if len(mmo_speeds) > 0:
        ax.plot(mmo_speeds, mmo_altitudes, 'darkred', linewidth=3,
               alpha=0.9, label='MMO (Mach 0.82 limit)')
    
    # ç»˜åˆ¶æœ€å°é©¬èµ«æ•°é™åˆ¶çº¿
    if len(min_mach_speeds) > 0:
        ax.plot(min_mach_speeds, min_mach_altitudes, 'orange', linewidth=3,
               alpha=0.9, label='Minimum Mach limit')
        
        # å¡«å……é©¬èµ«æ•°æ“ä½œåŒºåŸŸ
        if len(mmo_speeds) > 0:
            # æ‰¾åˆ°é‡å çš„é«˜åº¦èŒƒå›´
            common_altitudes = []
            mmo_speeds_interp = []
            min_speeds_interp = []
            
            for alt in min_mach_altitudes:
                if alt <= max(mmo_altitudes):
                    # æ’å€¼è·å–MMOåœ¨è¯¥é«˜åº¦çš„é€Ÿåº¦
                    mmo_speed_at_alt = np.interp(alt, mmo_altitudes, mmo_speeds)
                    min_speed_at_alt = np.interp(alt, min_mach_altitudes, min_mach_speeds)
                    
                    if mmo_speed_at_alt > min_speed_at_alt:
                        common_altitudes.append(alt)
                        mmo_speeds_interp.append(mmo_speed_at_alt)
                        min_speeds_interp.append(min_speed_at_alt)
            
            if len(common_altitudes) > 0:
                ax.fill_betweenx(common_altitudes, min_speeds_interp, mmo_speeds_interp,
                               color='yellow', alpha=0.15, 
                               label='Mach operating envelope')
    
    # VMOé™åˆ¶çº¿ - 340 kt åˆ°è½¬æ¢é«˜åº¦
    ax.axvline(x=340, ymin=0, ymax=transition_altitude/43000, 
              color='purple', linestyle='-', linewidth=3, alpha=0.9, 
              label='VMO (340 kt limit)')
    
    # VMO/MMOè½¬æ¢ç‚¹æ ‡æ³¨
    ax.plot(340, transition_altitude, 'ko', markersize=10, 
           markerfacecolor='yellow', markeredgecolor='black', linewidth=2,
           label='VMO/MMO transition')
    
    ax.annotate('VMO/MMO\nTransition\nFL280', 
               xy=(340, transition_altitude), 
               xytext=(380, transition_altitude-2000),
               arrowprops=dict(arrowstyle='->', color='black', lw=2),
               fontsize=11, ha='left', color='black', fontweight='bold',
               bbox=dict(boxstyle="round,pad=0.3", facecolor='yellow', alpha=0.8))
    
    print(f"âœ… æ·»åŠ äº†å®Œæ•´çš„é€Ÿåº¦é™åˆ¶ï¼šVMO + MMO + æœ€å°é©¬èµ«æ•°")
    print(f"   - VMO: 340 kt (sea level to FL280)")
    print(f"   - MMO: Mach 0.82 (above FL280)")
    print(f"   - Min Mach: 0.3-0.5 (high altitude)")

def setup_dual_axis(ax):
    """è®¾ç½®åŒè½´æ˜¾ç¤º"""
    
    # åˆ›å»ºé¡¶éƒ¨é©¬èµ«æ•°è½´
    ax2 = ax.twiny()
    
    # ä½¿ç”¨FL350ä½œä¸ºå‚è€ƒé«˜åº¦è®¡ç®—é©¬èµ«æ•°å¯¹åº”çš„æŒ‡ç¤ºç©ºé€Ÿ
    ref_alt_m = 35000 * 0.3048
    ref_temp = 288.15 * (1 - 0.0065 * ref_alt_m / 288.15)
    ref_density_ratio = (ref_temp / 288.15) ** 4.256
    ref_sound_speed = np.sqrt(1.4 * 287.053 * ref_temp)
    
    # é©¬èµ«æ•°åˆ»åº¦
    mach_ticks = [0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.75, 0.8, 0.82]
    indicated_speeds = []
    
    for mach in mach_ticks:
        true_speed = mach * ref_sound_speed
        indicated_speed = true_speed * np.sqrt(ref_density_ratio) * 1.94384
        indicated_speeds.append(indicated_speed)
    
    # è®¾ç½®é©¬èµ«æ•°è½´
    ax2.set_xlim(ax.get_xlim())
    ax2.set_xticks(indicated_speeds)
    ax2.set_xticklabels([f'{m:.2f}' for m in mach_ticks])
    ax2.set_xlabel('Mach Number (FL350 reference)', fontsize=12, 
                   fontweight='bold', color='navy')
    ax2.tick_params(axis='x', colors='navy')
    
    # æ·»åŠ é©¬èµ«æ•°ç½‘æ ¼
    for speed in indicated_speeds:
        if ax.get_xlim()[0] <= speed <= ax.get_xlim()[1]:
            ax.axvline(x=speed, color='navy', linestyle=':', alpha=0.3, linewidth=1)
    
    print("âœ… æ·»åŠ äº†åŒè½´æ˜¾ç¤º")

def add_reference_lines(ax):
    """æ·»åŠ å‚è€ƒçº¿"""
    
    # é‡è¦å·¡èˆªé«˜åº¦
    cruise_levels = [25000, 30000, 35000, 39000, 41000]
    for fl in cruise_levels:
        ax.axhline(y=fl, color='gray', linestyle=':', alpha=0.4, linewidth=1)
        ax.text(460, fl + 300, f'FL{fl//100}', fontsize=10, alpha=0.7,
               bbox=dict(boxstyle="round,pad=0.2", facecolor='white', alpha=0.8))

def add_performance_info(ax, aircraft, stall_speeds, max_speeds, valid_altitudes):
    """æ·»åŠ æ€§èƒ½ä¿¡æ¯æ¡†"""
    
    info_text = f"""BOEING 737-800 PERFORMANCE

Configuration: 
â€¢ Weight: {aircraft['operating_weight']:,.0f} kg (80% MTOW)
â€¢ Wing Area: {aircraft['wing_area']:.1f} mÂ²
â€¢ Max Mach: {aircraft['max_mach']}

Speed Limits:
â€¢ VMO: 340 kt (below FL280)
â€¢ MMO: Mach 0.82 (above FL280) 
â€¢ Service Ceiling: {aircraft['service_ceiling']:,} ft

Key Speeds (Sea Level):
â€¢ Stall: {stall_speeds[0]:.0f} kt
â€¢ Max: {max_speeds[0]:.0f} kt

Key Speeds (FL350):
â€¢ Stall: {stall_speeds[len(stall_speeds)//2]:.0f} kt
â€¢ Max: {max_speeds[len(max_speeds)//2]:.0f} kt

Wing Loading: {aircraft['operating_weight']/aircraft['wing_area']:.0f} kg/mÂ²"""
    
    props = dict(boxstyle='round,pad=0.8', facecolor='lightcyan', alpha=0.9)
    ax.text(0.02, 0.98, info_text, transform=ax.transAxes, fontsize=10,
           verticalalignment='top', fontfamily='monospace', bbox=props)

def print_key_performance(aircraft, stall_speeds, max_speeds, valid_altitudes):
    """è¾“å‡ºå…³é”®æ€§èƒ½æ•°æ®"""
    
    print(f"\nğŸ“Š Boeing 737-800 å…³é”®æ€§èƒ½ (80% MTOW)")
    print("=" * 50)
    print(f"ğŸ“ˆ æµ·å¹³é¢:")
    print(f"   å¤±é€Ÿé€Ÿåº¦: {stall_speeds[0]:.0f} kt")
    print(f"   æœ€å¤§é€Ÿåº¦: {max_speeds[0]:.0f} kt")
    
    # FL350æ€§èƒ½
    fl350_idx = np.argmin(np.abs(valid_altitudes - 35000))
    print(f"ğŸ“ˆ FL350 (35,000 ft):")
    print(f"   å¤±é€Ÿé€Ÿåº¦: {stall_speeds[fl350_idx]:.0f} kt")
    print(f"   æœ€å¤§é€Ÿåº¦: {max_speeds[fl350_idx]:.0f} kt")
    
    print(f"ğŸ“ˆ å®ç”¨å‡é™:")
    print(f"   æœ€å¤§é«˜åº¦: {valid_altitudes[-1]:.0f} ft")
    print(f"   å¤±é€Ÿé€Ÿåº¦: {stall_speeds[-1]:.0f} kt")
    
    print(f"ğŸ“ˆ é£è¡ŒåŒ…çº¿èŒƒå›´:")
    print(f"   é€Ÿåº¦èŒƒå›´: {stall_speeds.min():.0f} - {max_speeds.max():.0f} kt")
    print(f"   é«˜åº¦èŒƒå›´: 0 - {valid_altitudes.max():.0f} ft")

if __name__ == "__main__":
    print("ğŸ›©ï¸ Boeing 737-800 ç®€åŒ–é£è¡ŒåŒ…çº¿ç”Ÿæˆå™¨")
    print("ğŸ¯ å•ä¸€é…ç½®ï¼š80%å…¨é‡ï¼ŒåŒè½´æ˜¾ç¤º")
    print("=" * 50)
    
    fig, ax = create_simple_flight_envelope()
    
    print(f"\nğŸ‰ å®Œæˆ!")
    print(f"ğŸ’¡ ç®€æ´æ¸…æ™°çš„é£è¡ŒåŒ…çº¿å›¾å·²ç”Ÿæˆ")