<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯å¾„è§„åˆ’ä¸PIDæ§åˆ¶æ¼”ç¤º</title>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .map-container {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .map-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            color: #333;
        }
        
        canvas {
            border: 2px solid #333;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .pid-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .pid-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .pid-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        @media (max-width: 768px) {
            .map-container {
                flex-direction: column;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— ä»Aåˆ°Bçš„è·¯å¾„è§„åˆ’ä¸PIDæ§åˆ¶æ¼”ç¤º</h1>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff4757;"></div>
                <span>èµ·ç‚¹A</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ed573;"></div>
                <span>ç»ˆç‚¹B</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3742fa;"></div>
                <span>ç†æƒ³è·¯å¾„</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6348;"></div>
                <span>å®é™…è½¨è¿¹</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #57606f;"></div>
                <span>éšœç¢ç‰©</span>
            </div>
        </div>
        
        <div class="map-container">
            <div class="map-section">
                <h3 style="text-align: center; margin-bottom: 15px;">ğŸ¯ è·¯å¾„è§„åˆ’åœ°å›¾</h3>
                <canvas id="mapCanvas" width="400" height="300"></canvas>
                <div class="controls">
                    <button onclick="startSimulation()" id="startBtn">å¼€å§‹ä»¿çœŸ</button>
                    <button onclick="resetSimulation()" id="resetBtn">é‡ç½®</button>
                    <button onclick="togglePause()" id="pauseBtn">æš‚åœ</button>
                </div>
            </div>
            
            <div class="map-section">
                <h3 style="text-align: center; margin-bottom: 15px;">ğŸ“Š PIDæ§åˆ¶åˆ†æ</h3>
                <canvas id="errorCanvas" width="400" height="300"></canvas>
                <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;">
                    å®æ—¶è¯¯å·®æ›²çº¿ (è“: æ¨ªå‘è¯¯å·®, çº¢: èˆªå‘è¯¯å·®)
                </div>
            </div>
        </div>
        
        <div class="pid-info">
            <h3>ğŸ”§ PIDæ§åˆ¶å‚æ•°ä¸çŠ¶æ€</h3>
            <div class="pid-values">
                <div class="pid-value">
                    <div style="font-size: 24px; font-weight: bold;" id="pValue">P: 0.00</div>
                    <div>æ¯”ä¾‹é¡¹ (å½“å‰è¯¯å·®)</div>
                </div>
                <div class="pid-value">
                    <div style="font-size: 24px; font-weight: bold;" id="iValue">I: 0.00</div>
                    <div>ç§¯åˆ†é¡¹ (ç´¯ç§¯è¯¯å·®)</div>
                </div>
                <div class="pid-value">
                    <div style="font-size: 24px; font-weight: bold;" id="dValue">D: 0.00</div>
                    <div>å¾®åˆ†é¡¹ (è¯¯å·®å˜åŒ–ç‡)</div>
                </div>
                <div class="pid-value">
                    <div style="font-size: 24px; font-weight: bold;" id="steeringValue">è½¬å‘: 0Â°</div>
                    <div>æ–¹å‘ç›˜è§’åº¦</div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px;">
            <h3>ğŸ’¡ PIDæ§åˆ¶åŸç†è§£é‡Šï¼š</h3>
            <div style="line-height: 1.8; font-size: 16px;">
                <p><strong>ğŸ¯ Pæ§åˆ¶ (æ¯”ä¾‹é¡¹)ï¼š</strong> æ ¹æ®è½¦è¾†ä¸ç›®æ ‡è·¯å¾„çš„å½“å‰è·ç¦»åå·®æ¥è°ƒæ•´è½¬å‘è§’åº¦ã€‚åç¦»è¶Šè¿œï¼Œè½¬å‘è¶Šå¤§ã€‚</p>
                <p><strong>ğŸ“ˆ Iæ§åˆ¶ (ç§¯åˆ†é¡¹)ï¼š</strong> ç´¯ç§¯å†å²åå·®ï¼Œæ¶ˆé™¤ç³»ç»Ÿæ€§è¯¯å·®ã€‚å¦‚æœè½¦è¾†æ€»æ˜¯åå‘ä¸€ä¾§ï¼Œç§¯åˆ†é¡¹ä¼šé€æ¸çº æ­£ã€‚</p>
                <p><strong>âš¡ Dæ§åˆ¶ (å¾®åˆ†é¡¹)ï¼š</strong> æ ¹æ®è¯¯å·®çš„å˜åŒ–è¶‹åŠ¿é¢„æµ‹æ€§è°ƒæ•´ï¼Œé˜²æ­¢è¿‡åº¦è½¬å‘é€ æˆéœ‡è¡ã€‚</p>
                <p><strong>ğŸš— æ€»æ§åˆ¶è¾“å‡ºï¼š</strong> è½¬å‘è§’ = KpÃ—è¯¯å·® + KiÃ—Î£è¯¯å·® + KdÃ—è¯¯å·®å˜åŒ–ç‡</p>
            </div>
        </div>
    </div>

    <script>
        const mapCanvas = document.getElementById('mapCanvas');
        const mapCtx = mapCanvas.getContext('2d');
        const errorCanvas = document.getElementById('errorCanvas');
        const errorCtx = errorCanvas.getContext('2d');
        
        let animationRunning = false;
        let animationPaused = false;
        let animationId = null;
        
        // è·¯å¾„ç‚¹å’Œè½¦è¾†çŠ¶æ€
        const pathPoints = [
            {x: 50, y: 250},   // Aç‚¹
            {x: 100, y: 200},
            {x: 150, y: 180},
            {x: 200, y: 160},
            {x: 250, y: 140},
            {x: 300, y: 120},
            {x: 350, y: 100}   // Bç‚¹
        ];
        
        const obstacles = [
            {x: 180, y: 200, width: 40, height: 30},
            {x: 280, y: 180, width: 35, height: 25}
        ];
        
        let vehicle = {
            x: 50,
            y: 250,
            angle: -Math.PI/6,
            targetIndex: 1,
            lateralError: 0,
            headingError: 0,
            errorIntegral: 0,
            previousError: 0,
            actualPath: [{x: 50, y: 250}],
            errorHistory: []
        };
        
        // PIDå‚æ•°
        const pid = {
            kp: 2.0,
            ki: 0.1,
            kd: 0.5
        };
        
        function drawMap() {
            mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            mapCtx.strokeStyle = '#f0f0f0';
            mapCtx.lineWidth = 0.5;
            for(let i = 0; i < mapCanvas.width; i += 20) {
                mapCtx.beginPath();
                mapCtx.moveTo(i, 0);
                mapCtx.lineTo(i, mapCanvas.height);
                mapCtx.stroke();
            }
            for(let i = 0; i < mapCanvas.height; i += 20) {
                mapCtx.beginPath();
                mapCtx.moveTo(0, i);
                mapCtx.lineTo(mapCanvas.width, i);
                mapCtx.stroke();
            }
            
            // ç»˜åˆ¶ç†æƒ³è·¯å¾„
            mapCtx.strokeStyle = '#3742fa';
            mapCtx.lineWidth = 3;
            mapCtx.beginPath();
            mapCtx.moveTo(pathPoints[0].x, pathPoints[0].y);
            for(let i = 1; i < pathPoints.length; i++) {
                mapCtx.lineTo(pathPoints[i].x, pathPoints[i].y);
            }
            mapCtx.stroke();
            
            // ç»˜åˆ¶è·¯å¾„ç‚¹
            pathPoints.forEach((point, index) => {
                if(index === 0) {
                    // èµ·ç‚¹A
                    mapCtx.fillStyle = '#ff4757';
                    mapCtx.beginPath();
                    mapCtx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
                    mapCtx.fill();
                    mapCtx.fillStyle = 'white';
                    mapCtx.font = 'bold 12px Arial';
                    mapCtx.textAlign = 'center';
                    mapCtx.fillText('A', point.x, point.y + 4);
                } else if(index === pathPoints.length - 1) {
                    // ç»ˆç‚¹B
                    mapCtx.fillStyle = '#2ed573';
                    mapCtx.beginPath();
                    mapCtx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
                    mapCtx.fill();
                    mapCtx.fillStyle = 'white';
                    mapCtx.font = 'bold 12px Arial';
                    mapCtx.textAlign = 'center';
                    mapCtx.fillText('B', point.x, point.y + 4);
                } else {
                    // ä¸­é—´ç‚¹
                    mapCtx.fillStyle = '#3742fa';
                    mapCtx.beginPath();
                    mapCtx.arc(point.x, point.y, 4, 0, 2 * Math.PI);
                    mapCtx.fill();
                }
            });
            
            // ç»˜åˆ¶éšœç¢ç‰©
            mapCtx.fillStyle = '#57606f';
            obstacles.forEach(obs => {
                mapCtx.fillRect(obs.x, obs.y, obs.width, obs.height);
            });
            
            // ç»˜åˆ¶å®é™…è½¨è¿¹
            if(vehicle.actualPath.length > 1) {
                mapCtx.strokeStyle = '#ff6348';
                mapCtx.lineWidth = 2;
                mapCtx.beginPath();
                mapCtx.moveTo(vehicle.actualPath[0].x, vehicle.actualPath[0].y);
                for(let i = 1; i < vehicle.actualPath.length; i++) {
                    mapCtx.lineTo(vehicle.actualPath[i].x, vehicle.actualPath[i].y);
                }
                mapCtx.stroke();
            }
            
            // ç»˜åˆ¶è½¦è¾†
            mapCtx.save();
            mapCtx.translate(vehicle.x, vehicle.y);
            mapCtx.rotate(vehicle.angle);
            
            // è½¦èº«
            mapCtx.fillStyle = '#2c2c54';
            mapCtx.fillRect(-8, -4, 16, 8);
            
            // è½¦å¤´
            mapCtx.fillStyle = '#ff3838';
            mapCtx.fillRect(6, -2, 4, 4);
            
            mapCtx.restore();
            
            // ç»˜åˆ¶è¯¯å·®çº¿
            if(vehicle.targetIndex < pathPoints.length) {
                const target = pathPoints[vehicle.targetIndex];
                mapCtx.strokeStyle = '#ff9ff3';
                mapCtx.lineWidth = 1;
                mapCtx.setLineDash([5, 5]);
                mapCtx.beginPath();
                mapCtx.moveTo(vehicle.x, vehicle.y);
                mapCtx.lineTo(target.x, target.y);
                mapCtx.stroke();
                mapCtx.setLineDash([]);
            }
        }
        
        function drawErrorGraph() {
            errorCtx.clearRect(0, 0, errorCanvas.width, errorCanvas.height);
            
            if(vehicle.errorHistory.length < 2) return;
            
            // ç»˜åˆ¶ç½‘æ ¼
            errorCtx.strokeStyle = '#f0f0f0';
            errorCtx.lineWidth = 0.5;
            for(let i = 0; i < errorCanvas.width; i += 40) {
                errorCtx.beginPath();
                errorCtx.moveTo(i, 0);
                errorCtx.lineTo(i, errorCanvas.height);
                errorCtx.stroke();
            }
            for(let i = 0; i < errorCanvas.height; i += 30) {
                errorCtx.beginPath();
                errorCtx.moveTo(0, i);
                errorCtx.lineTo(errorCanvas.width, i);
                errorCtx.stroke();
            }
            
            // ä¸­å¿ƒçº¿
            errorCtx.strokeStyle = '#ccc';
            errorCtx.lineWidth = 1;
            errorCtx.beginPath();
            errorCtx.moveTo(0, errorCanvas.height/2);
            errorCtx.lineTo(errorCanvas.width, errorCanvas.height/2);
            errorCtx.stroke();
            
            const maxPoints = 200;
            const startIndex = Math.max(0, vehicle.errorHistory.length - maxPoints);
            const history = vehicle.errorHistory.slice(startIndex);
            
            if(history.length > 1) {
                const xStep = errorCanvas.width / Math.max(history.length - 1, 1);
                
                // ç»˜åˆ¶æ¨ªå‘è¯¯å·®
                errorCtx.strokeStyle = '#3742fa';
                errorCtx.lineWidth = 2;
                errorCtx.beginPath();
                history.forEach((error, index) => {
                    const x = index * xStep;
                    const y = errorCanvas.height/2 - error.lateral * 2;
                    if(index === 0) {
                        errorCtx.moveTo(x, y);
                    } else {
                        errorCtx.lineTo(x, y);
                    }
                });
                errorCtx.stroke();
                
                // ç»˜åˆ¶èˆªå‘è¯¯å·®
                errorCtx.strokeStyle = '#ff4757';
                errorCtx.lineWidth = 2;
                errorCtx.beginPath();
                history.forEach((error, index) => {
                    const x = index * xStep;
                    const y = errorCanvas.height/2 - error.heading * 20;
                    if(index === 0) {
                        errorCtx.moveTo(x, y);
                    } else {
                        errorCtx.lineTo(x, y);
                    }
                });
                errorCtx.stroke();
            }
        }
        
        function calculatePID() {
            if(vehicle.targetIndex >= pathPoints.length) return 0;
            
            const target = pathPoints[vehicle.targetIndex];
            
            // è®¡ç®—æ¨ªå‘è¯¯å·®
            const dx = target.x - vehicle.x;
            const dy = target.y - vehicle.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            // è®¡ç®—ç›®æ ‡è§’åº¦
            const targetAngle = Math.atan2(dy, dx);
            
            // è®¡ç®—èˆªå‘è¯¯å·®
            let headingError = targetAngle - vehicle.angle;
            while(headingError > Math.PI) headingError -= 2*Math.PI;
            while(headingError < -Math.PI) headingError += 2*Math.PI;
            
            // æ¨ªå‘è¯¯å·® (è½¦è¾†åˆ°ç›®æ ‡ç‚¹çš„è·ç¦»)
            const lateralError = distance * Math.sin(headingError);
            
            // æ›´æ–°ç§¯åˆ†é¡¹
            vehicle.errorIntegral += lateralError;
            
            // é™åˆ¶ç§¯åˆ†é¡¹é˜²æ­¢ç§¯åˆ†é¥±å’Œ
            vehicle.errorIntegral = Math.max(-50, Math.min(50, vehicle.errorIntegral));
            
            // è®¡ç®—å¾®åˆ†é¡¹
            const errorDerivative = lateralError - vehicle.previousError;
            
            // PIDè¾“å‡º
            const pTerm = pid.kp * lateralError;
            const iTerm = pid.ki * vehicle.errorIntegral;
            const dTerm = pid.kd * errorDerivative;
            
            const steering = pTerm + iTerm + dTerm;
            
            // æ›´æ–°çŠ¶æ€
            vehicle.lateralError = lateralError;
            vehicle.headingError = headingError;
            vehicle.previousError = lateralError;
            
            // è®°å½•è¯¯å·®å†å²
            vehicle.errorHistory.push({
                lateral: lateralError,
                heading: headingError,
                time: Date.now()
            });
            
            // æ›´æ–°UI
            document.getElementById('pValue').textContent = `P: ${pTerm.toFixed(2)}`;
            document.getElementById('iValue').textContent = `I: ${iTerm.toFixed(2)}`;
            document.getElementById('dValue').textContent = `D: ${dTerm.toFixed(2)}`;
            document.getElementById('steeringValue').textContent = `è½¬å‘: ${(steering * 180/Math.PI).toFixed(1)}Â°`;
            
            return steering;
        }
        
        function updateVehicle() {
            if(vehicle.targetIndex >= pathPoints.length) return;
            
            const steering = calculatePID();
            
            // æ›´æ–°è½¦è¾†çŠ¶æ€ï¼ˆç®€åŒ–çš„è½¦è¾†æ¨¡å‹ï¼‰
            const speed = 2.0;
            vehicle.angle += steering * 0.1;
            vehicle.x += speed * Math.cos(vehicle.angle);
            vehicle.y += speed * Math.sin(vehicle.angle);
            
            // è®°å½•è½¨è¿¹
            vehicle.actualPath.push({x: vehicle.x, y: vehicle.y});
            
            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å½“å‰ç›®æ ‡ç‚¹
            const target = pathPoints[vehicle.targetIndex];
            const distanceToTarget = Math.sqrt(
                (vehicle.x - target.x)**2 + (vehicle.y - target.y)**2
            );
            
            if(distanceToTarget < 15 && vehicle.targetIndex < pathPoints.length - 1) {
                vehicle.targetIndex++;
                // é‡ç½®ç§¯åˆ†é¡¹é¿å…è¿‡å†²
                vehicle.errorIntegral *= 0.5;
            }
        }
        
        function animate() {
            if(!animationRunning || animationPaused) return;
            
            updateVehicle();
            drawMap();
            drawErrorGraph();
            
            if(vehicle.targetIndex < pathPoints.length) {
                animationId = requestAnimationFrame(animate);
            } else {
                animationRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = 'å¼€å§‹ä»¿çœŸ';
            }
        }
        
        function startSimulation() {
            if(!animationRunning) {
                animationRunning = true;
                animationPaused = false;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').textContent = 'ä»¿çœŸä¸­...';
                document.getElementById('pauseBtn').textContent = 'æš‚åœ';
                animate();
            }
        }
        
        function resetSimulation() {
            animationRunning = false;
            animationPaused = false;
            if(animationId) {
                cancelAnimationFrame(animationId);
            }
            
            vehicle = {
                x: 50,
                y: 250,
                angle: -Math.PI/6,
                targetIndex: 1,
                lateralError: 0,
                headingError: 0,
                errorIntegral: 0,
                previousError: 0,
                actualPath: [{x: 50, y: 250}],
                errorHistory: []
            };
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'å¼€å§‹ä»¿çœŸ';
            document.getElementById('pauseBtn').textContent = 'æš‚åœ';
            
            // é‡ç½®UIæ˜¾ç¤º
            document.getElementById('pValue').textContent = 'P: 0.00';
            document.getElementById('iValue').textContent = 'I: 0.00';
            document.getElementById('dValue').textContent = 'D: 0.00';
            document.getElementById('steeringValue').textContent = 'è½¬å‘: 0Â°';
            
            drawMap();
            errorCtx.clearRect(0, 0, errorCanvas.width, errorCanvas.height);
        }
        
        function togglePause() {
            if(animationRunning) {
                animationPaused = !animationPaused;
                document.getElementById('pauseBtn').textContent = animationPaused ? 'ç»§ç»­' : 'æš‚åœ';
                if(!animationPaused) {
                    animate();
                }
            }
        }
        
        // åˆå§‹åŒ–
        drawMap();
        
        // å“åº”å¼è®¾è®¡
        function resizeCanvases() {
            const container = document.querySelector('.map-section');
            const maxWidth = Math.min(400, container.clientWidth - 40);
            
            if(maxWidth < 400) {
                mapCanvas.style.width = maxWidth + 'px';
                mapCanvas.style.height = (maxWidth * 0.75) + 'px';
                errorCanvas.style.width = maxWidth + 'px';
                errorCanvas.style.height = (maxWidth * 0.75) + 'px';
            }
        }
        
        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();
    </script>
</body>
</html>