<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPC数学公式详解</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .formula-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            color: #333;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        
        .main-formula {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            color: white;
            padding: 25px;
            border-radius: 12px;
            font-family: 'Times New Roman', serif;
            font-size: 1.3em;
            text-align: center;
            margin: 20px 0;
            border: 3px solid #ffd700;
        }
        
        .formula-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .component-card {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .component-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .objective { border-left-color: #e74c3c; }
        .constraints { border-left-color: #2ecc71; }
        .variables { border-left-color: #f39c12; }
        .model { border-left-color: #9b59b6; }
        
        .component-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .math-notation {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Times New Roman', serif;
            font-size: 1.1em;
            margin: 10px 0;
            text-align: center;
        }
        
        .interpretation {
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #3498db;
            margin: 10px 0;
            font-style: italic;
        }
        
        .step-by-step {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            color: #333;
        }
        
        .step {
            background: linear-gradient(145deg, rgba(255,255,255,0.8), rgba(248,249,250,0.8));
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
            position: relative;
        }
        
        .step-number {
            position: absolute;
            left: -15px;
            top: -10px;
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }
        
        .example-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            color: #333;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .example-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #e74c3c;
            text-align: center;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .highlight-box {
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #ffd700;
            text-align: center;
        }
        
        .visual-explanation {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            color: #333;
            text-align: center;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(to right, #3498db, #2ecc71);
            border-radius: 8px;
            color: white;
        }
        
        .time-step {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .constraint-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .constraint-type {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            border-top: 3px solid #3498db;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .comparison-table th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .optimization-flow {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            color: #333;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
        }
        
        .flow-arrow {
            font-size: 2em;
            color: #3498db;
            margin: 0 15px;
        }
        
        @media (max-width: 768px) {
            .formula-breakdown {
                grid-template-columns: 1fr;
            }
            
            .examples-grid {
                grid-template-columns: 1fr;
            }
            
            .timeline {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧮 MPC数学公式详解</h1>
        
        <div class="formula-section">
            <h2 style="text-align: center; color: #333; margin-bottom: 25px;">核心优化问题</h2>
            
            <div class="main-formula">
                U*<sub>t</sub>(x(t)) := argmin<sub>U<sub>t</sub></sub> Σ<sup>N-1</sup><sub>k=0</sub> q(x<sub>t+k</sub>, u<sub>t+k</sub>)<br><br>
                subject to:<br>
                x<sub>t</sub> = x(t) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (measurement)<br>
                x<sub>t+k+1</sub> = Ax<sub>t+k</sub> + Bu<sub>t+k</sub> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (system model)<br>
                x<sub>t+k</sub> ∈ X &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (state constraints)<br>
                u<sub>t+k</sub> ∈ U &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (input constraints)<br><br>
                U<sub>t</sub> = {u<sub>0</sub>, u<sub>1</sub>, ..., u<sub>N-1</sub>} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (optimization variables)
            </div>
        </div>
        
        <div class="highlight-box">
            <h2 style="color: #ffd700; margin-top: 0;">🎯 公式核心思想</h2>
            <p style="font-size: 1.3em;">
                在满足系统动态和约束条件下，<br>
                寻找<strong>未来N步的最优控制序列</strong>，<br>
                使得<strong>预测期内的性能指标最小化</strong>
            </p>
        </div>
        
        <div class="formula-breakdown">
            <div class="component-card objective">
                <h3 class="component-title">🎯 目标函数</h3>
                <div class="math-notation">
                    min Σ<sup>N-1</sup><sub>k=0</sub> q(x<sub>t+k</sub>, u<sub>t+k</sub>)
                </div>
                <div class="interpretation">
                    <strong>含义：</strong>最小化未来N步的累积代价<br>
                    <strong>q(x,u)：</strong>单步代价函数
                </div>
                <p><strong>常见形式：</strong></p>
                <ul>
                    <li><strong>跟踪型：</strong> ||x-r||²<sub>Q</sub> + ||u||²<sub>R</sub></li>
                    <li><strong>调节型：</strong> ||x||²<sub>Q</sub> + ||u||²<sub>R</sub></li>
                    <li><strong>经济型：</strong> -profit(x,u) + cost(u)</li>
                </ul>
            </div>
            
            <div class="component-card model">
                <h3 class="component-title">🔧 系统模型</h3>
                <div class="math-notation">
                    x<sub>t+k+1</sub> = Ax<sub>t+k</sub> + Bu<sub>t+k</sub>
                </div>
                <div class="interpretation">
                    <strong>含义：</strong>系统的状态空间模型<br>
                    <strong>作用：</strong>预测未来状态演化
                </div>
                <p><strong>模型类型：</strong></p>
                <ul>
                    <li><strong>线性模型：</strong> ẋ = Ax + Bu</li>
                    <li><strong>非线性模型：</strong> ẋ = f(x,u)</li>
                    <li><strong>离散模型：</strong> x<sub>k+1</sub> = f(x<sub>k</sub>,u<sub>k</sub>)</li>
                    <li><strong>多变量模型：</strong> 多输入多输出</li>
                </ul>
            </div>
            
            <div class="component-card constraints">
                <h3 class="component-title">⚖️ 约束条件</h3>
                <div class="math-notation">
                    x<sub>t+k</sub> ∈ X, &nbsp; u<sub>t+k</sub> ∈ U
                </div>
                <div class="interpretation">
                    <strong>含义：</strong>状态和控制输入的可行域<br>
                    <strong>作用：</strong>确保系统安全运行
                </div>
                <div class="constraint-types">
                    <div class="constraint-type">
                        <strong>输入约束</strong><br>
                        u<sub>min</sub> ≤ u ≤ u<sub>max</sub>
                    </div>
                    <div class="constraint-type">
                        <strong>状态约束</strong><br>
                        x<sub>min</sub> ≤ x ≤ x<sub>max</sub>
                    </div>
                    <div class="constraint-type">
                        <strong>输出约束</strong><br>
                        y<sub>min</sub> ≤ Cx ≤ y<sub>max</sub>
                    </div>
                </div>
            </div>
            
            <div class="component-card variables">
                <h3 class="component-title">🔢 优化变量</h3>
                <div class="math-notation">
                    U<sub>t</sub> = {u<sub>0</sub>, u<sub>1</sub>, ..., u<sub>N-1</sub>}
                </div>
                <div class="interpretation">
                    <strong>含义：</strong>未来N步的控制序列<br>
                    <strong>维度：</strong> N × n<sub>u</sub> (N步 × 控制输入数)
                </div>
                <p><strong>求解方式：</strong></p>
                <ul>
                    <li><strong>在线优化：</strong>每个采样时刻求解</li>
                    <li><strong>滚动时域：</strong>只执行第一步u<sub>0</sub></li>
                    <li><strong>反馈更新：</strong>基于新测量重新优化</li>
                </ul>
            </div>
        </div>
        
        <div class="step-by-step">
            <h2 style="text-align: center; color: #333; margin-bottom: 30px;">🔄 MPC算法执行流程</h2>
            
            <div class="visual-explanation">
                <h3>时间轴示意</h3>
                <div class="timeline">
                    <div class="time-step">t (当前)</div>
                    <div class="time-step">t+1</div>
                    <div class="time-step">t+2</div>
                    <div class="time-step">...</div>
                    <div class="time-step">t+N-1</div>
                </div>
                <p style="color: #666;">
                    <strong>预测时域：</strong>向前预测N步<br>
                    <strong>控制时域：</strong>优化未来N步的控制动作
                </p>
            </div>
            
            <div class="step">
                <div class="step-number">1</div>
                <h3>测量当前状态</h3>
                <div class="math-notation">x<sub>t</sub> = x(t)</div>
                <p>获取系统当前的状态信息，作为优化问题的初始条件</p>
            </div>
            
            <div class="step">
                <div class="step-number">2</div>
                <h3>建立优化问题</h3>
                <div class="code-block">
minimize: Σ q(x[t+k], u[t+k])
subject to:
    x[t+k+1] = f(x[t+k], u[t+k])  # 动态约束
    g(x[t+k], u[t+k]) ≤ 0         # 不等式约束
    h(x[t+k], u[t+k]) = 0         # 等式约束
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">3</div>
                <h3>求解优化问题</h3>
                <div class="math-notation">U*<sub>t</sub> = argmin J(x<sub>t</sub>, U<sub>t</sub>)</div>
                <p>使用数值优化算法（如SQP、内点法、梯度下降等）求解最优控制序列</p>
            </div>
            
            <div class="step">
                <div class="step-number">4</div>
                <h3>执行第一步控制</h3>
                <div class="math-notation">u(t) = u*<sub>0</sub></div>
                <p>只执行最优序列的第一个控制动作，其余动作作为预测保留</p>
            </div>
            
            <div class="step">
                <div class="step-number">5</div>
                <h3>滚动时域优化</h3>
                <p>在下一个采样时刻，基于新的测量值重复上述过程</p>
                <div class="flow-step">
                    <span>t → t+1</span>
                    <div class="flow-arrow">➜</div>
                    <span>重新测量</span>
                    <div class="flow-arrow">➜</div>
                    <span>重新优化</span>
                    <div class="flow-arrow">➜</div>
                    <span>执行新控制</span>
                </div>
            </div>
        </div>
        
        <div class="examples-grid">
            <div class="example-card">
                <h3 class="example-title">📊 跟踪控制示例</h3>
                <div class="code-block">
# 目标：跟踪参考轨迹
minimize: Σ[||x[k]-r[k]||²Q + ||u[k]||²R]

# 其中：
# Q: 状态权重矩阵 (跟踪精度)
# R: 控制权重矩阵 (控制能耗)
# r[k]: 参考轨迹

# 物理含义：
# 平衡跟踪精度和控制成本
                </div>
                <p><strong>应用：</strong>机器人轨迹跟踪、车辆路径跟踪</p>
            </div>
            
            <div class="example-card">
                <h3 class="example-title">🏭 调节控制示例</h3>
                <div class="code-block">
# 目标：稳定到平衡点
minimize: Σ[||x[k]||²Q + ||u[k]||²R]

# 约束：
# -5 ≤ u[k] ≤ 5     # 执行器限制
# 0 ≤ x₁[k] ≤ 100   # 温度范围
# x₂[k] ≥ 0         # 压力非负

# 物理含义：
# 在约束下快速稳定系统
                </div>
                <p><strong>应用：</strong>化工过程控制、电力系统稳定</p>
            </div>
            
            <div class="example-card">
                <h3 class="example-title">💰 经济优化示例</h3>
                <div class="code-block">
# 目标：最大化经济效益
minimize: Σ[-profit(x[k],u[k]) + cost(u[k])]

# 其中：
# profit(): 生产收益函数
# cost(): 操作成本函数

# 约束：
# 安全约束 + 设备限制 + 质量要求

# 物理含义：
# 在安全前提下最大化利润
                </div>
                <p><strong>应用：</strong>炼油厂优化、电网经济调度</p>
            </div>
        </div>
        
        <div class="optimization-flow">
            <h2 style="text-align: center; color: #333; margin-bottom: 25px;">⚙️ 优化求解过程</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>求解方法</th>
                        <th>适用场景</th>
                        <th>计算复杂度</th>
                        <th>求解质量</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>二次规划 (QP)</strong></td>
                        <td>线性系统 + 二次目标</td>
                        <td>O(n³)</td>
                        <td>全局最优</td>
                    </tr>
                    <tr>
                        <td><strong>序列二次规划 (SQP)</strong></td>
                        <td>非线性系统</td>
                        <td>高</td>
                        <td>局部最优</td>
                    </tr>
                    <tr>
                        <td><strong>内点法</strong></td>
                        <td>大规模问题</td>
                        <td>中等</td>
                        <td>全局最优 (凸问题)</td>
                    </tr>
                    <tr>
                        <td><strong>梯度下降</strong></td>
                        <td>实时性要求高</td>
                        <td>低</td>
                        <td>近似解</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="highlight-box">
            <h2 style="color: #ffd700; margin-top: 0;">💡 关键洞察</h2>
            <div style="font-size: 1.1em; text-align: left; max-width: 800px; margin: 0 auto;">
                <p><strong>🎯 MPC = 预测 + 优化 + 反馈</strong></p>
                <p>• <strong>预测：</strong>用模型预测未来N步系统行为</p>
                <p>• <strong>优化：</strong>在约束下寻找最优控制序列</p>
                <p>• <strong>反馈：</strong>基于新测量滚动更新优化</p>
                <br>
                <p><strong>📈 为什么MPC强大？</strong></p>
                <p>• 天然处理多变量和约束</p>
                <p>• 可以优化复杂的性能指标</p>
                <p>• 具有预测和前瞻能力</p>
                <p>• 能处理时变和非线性系统</p>
                <br>
                <p style="font-style: italic; color: #ffd700; text-align: center;">
                    "MPC把控制问题转化为在线优化问题"
                </p>
            </div>
        </div>
    </div>
</body>
</html>
