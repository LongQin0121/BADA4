<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bearing Range Line -  MAP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 10px 0;
        }
        
        .map-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 250px;
        }
        
        .controls h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2rem;
        }
        
        .distance-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .distance-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .point-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .instructions h3 {
            color: #333;
            margin-top: 0;
        }
        
        .instructions ul {
            color: #666;
            line-height: 1.6;
        }
        
        .custom-marker {
            background: #ff6b6b;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ Bearing Range Line - MAP</h1>
            <p>ç‚¹å‡»åœ°å›¾æ·»åŠ æ ‡è®°ç‚¹ï¼Œè‡ªåŠ¨è®¡ç®—ç›¸é‚»ç‚¹ä¹‹é—´çš„è·ç¦»</p>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="controls">
                <h3>ğŸ“Š è·ç¦»ä¿¡æ¯</h3>
                <div class="distance-info">
                    <div class="distance-value" id="totalDistance">0.00 km</div>
                    <div class="point-count" id="pointCount">å·²æ·»åŠ  0 ä¸ªç‚¹</div>
                </div>
                
                <button class="btn" onclick="clearAllPoints()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç‚¹</button>
                <button class="btn" onclick="undoLastPoint()">â†©ï¸ æ’¤é”€ä¸Šä¸€ç‚¹</button>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ğŸ¯ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>ç‚¹å‡»åœ°å›¾</strong>ï¼šåœ¨ä»»æ„ä½ç½®æ·»åŠ æ ‡è®°ç‚¹</li>
                <li><strong>è‡ªåŠ¨è®¡ç®—</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—ç›¸é‚»ä¸¤ç‚¹ä¹‹é—´çš„ç›´çº¿è·ç¦»</li>
                <li><strong>ç´¯è®¡è·ç¦»</strong>ï¼šå³ä¸Šè§’æ˜¾ç¤ºæ€»è·¯å¾„é•¿åº¦</li>
                <li><strong>æ¸…é™¤é‡ç½®</strong>ï¼šå¯ä»¥æ¸…é™¤æ‰€æœ‰ç‚¹æˆ–æ’¤é”€æœ€åä¸€ä¸ªç‚¹</li>
                <li><strong>åœ°å›¾æ“ä½œ</strong>ï¼šæ”¯æŒç¼©æ”¾ã€æ‹–æ‹½æµè§ˆæ•´ä¸ªä¸Šæµ·åœ°åŒº</li>
            </ul>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°å›¾ï¼Œä»¥ä¸Šæµ·ä¸ºä¸­å¿ƒ
        const map = L.map('map').setView([31.2304, 121.4737], 10);

        // æ·»åŠ åœ°å›¾å›¾å±‚
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // å­˜å‚¨æ‰€æœ‰æ ‡è®°ç‚¹å’Œçº¿æ®µ
        let markers = [];
        let polylines = [];
        let totalDistance = 0;

        // è‡ªå®šä¹‰æ ‡è®°ç‚¹å›¾æ ‡
        const createCustomIcon = (number) => {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    width: 100%; 
                    height: 100%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: white; 
                    font-weight: bold; 
                    font-size: 12px;
                ">${number}</div>`,
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            });
        };

        // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆä½¿ç”¨Haversineå…¬å¼ï¼‰
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // æ›´æ–°è·ç¦»æ˜¾ç¤º
        function updateDistanceDisplay() {
            document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(2)} km`;
            document.getElementById('pointCount').textContent = `å·²æ·»åŠ  ${markers.length} ä¸ªç‚¹`;
        }

        // åœ°å›¾ç‚¹å‡»äº‹ä»¶
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const pointNumber = markers.length + 1;

            // åˆ›å»ºæ–°æ ‡è®°
            const marker = L.marker([lat, lng], {
                icon: createCustomIcon(pointNumber)
            }).addTo(map);

            // æ·»åŠ å¼¹å‡ºä¿¡æ¯
            marker.bindPopup(`
                <div style="text-align: center; min-width: 150px;">
                    <h4 style="margin: 5px 0; color: #333;">ğŸ“ ç‚¹ ${pointNumber}</h4>
                    <p style="margin: 5px 0; color: #666;">
                        çº¬åº¦: ${lat.toFixed(6)}<br>
                        ç»åº¦: ${lng.toFixed(6)}
                    </p>
                </div>
            `);

            // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªç‚¹ï¼Œè®¡ç®—ä¸å‰ä¸€ä¸ªç‚¹çš„è·ç¦»å¹¶ç»˜åˆ¶è¿çº¿
            if (markers.length > 0) {
                const prevMarker = markers[markers.length - 1];
                const prevLat = prevMarker.getLatLng().lat;
                const prevLng = prevMarker.getLatLng().lng;
                
                // è®¡ç®—è·ç¦»
                const distance = calculateDistance(prevLat, prevLng, lat, lng);
                totalDistance += distance;

                // ç»˜åˆ¶è¿çº¿
                const polyline = L.polyline([
                    [prevLat, prevLng],
                    [lat, lng]
                ], {
                    color: '#ff6b6b',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(map);

                // åœ¨è¿çº¿ä¸­ç‚¹æ·»åŠ è·ç¦»æ ‡ç­¾
                const midLat = (prevLat + lat) / 2;
                const midLng = (prevLng + lng) / 2;
                
                const distanceLabel = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: 'distance-label',
                        html: `<div style="
                            background: rgba(255, 107, 107, 0.9);
                            color: white;
                            padding: 4px 8px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                        ">${distance.toFixed(2)} km</div>`,
                        iconSize: [0, 0]
                    })
                }).addTo(map);

                polylines.push({ line: polyline, label: distanceLabel, distance: distance });
            }

            markers.push(marker);
            updateDistanceDisplay();

            // æ·»åŠ ä¸€äº›åŠ¨ç”»æ•ˆæœ
            setTimeout(() => {
                marker.openPopup();
            }, 300);
        });

        // æ¸…é™¤æ‰€æœ‰ç‚¹
        function clearAllPoints() {
            // ç§»é™¤æ‰€æœ‰æ ‡è®°
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // ç§»é™¤æ‰€æœ‰è¿çº¿å’Œè·ç¦»æ ‡ç­¾
            polylines.forEach(item => {
                map.removeLayer(item.line);
                map.removeLayer(item.label);
            });
            polylines = [];

            totalDistance = 0;
            updateDistanceDisplay();
        }

        // æ’¤é”€æœ€åä¸€ä¸ªç‚¹
        function undoLastPoint() {
            if (markers.length === 0) return;

            // ç§»é™¤æœ€åä¸€ä¸ªæ ‡è®°
            const lastMarker = markers.pop();
            map.removeLayer(lastMarker);

            // å¦‚æœæœ‰è¿çº¿ï¼Œç§»é™¤æœ€åä¸€æ¡è¿çº¿
            if (polylines.length > 0) {
                const lastPolyline = polylines.pop();
                map.removeLayer(lastPolyline.line);
                map.removeLayer(lastPolyline.label);
                totalDistance -= lastPolyline.distance;
            }

            updateDistanceDisplay();
        }

        // æ·»åŠ ä¸€äº›è‘—ååœ°æ ‡ä½œä¸ºå‚è€ƒ
        const landmarks = [
            { name: "å¤–æ»©", lat: 31.2396, lng: 121.4906 },
            { name: "ä¸œæ–¹æ˜ç ", lat: 31.2397, lng: 121.4999 },
            { name: "äººæ°‘å¹¿åœº", lat: 31.2307, lng: 121.4748 },
            { name: "é™†å®¶å˜´", lat: 31.2384, lng: 121.5041 },
            { name: "è™¹æ¡¥æœºåœº", lat: 31.1979, lng: 121.3364 }
        ];

        landmarks.forEach(landmark => {
            L.marker([landmark.lat, landmark.lng], {
                icon: L.divIcon({
                    className: 'landmark-marker',
                    html: `<div style="
                        background: #4CAF50;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 10px;
                        font-size: 10px;
                        white-space: nowrap;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    ">${landmark.name}</div>`,
                    iconSize: [0, 0]
                })
            }).addTo(map);
        });

        // åˆå§‹åŒ–æ˜¾ç¤º
        updateDistanceDisplay();
    </script>
</body>
</html>